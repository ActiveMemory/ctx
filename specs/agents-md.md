# AGENTS.md: Universal Agent Instructions

## Problem

ctx's project instructions live in CLAUDE.md — a Claude Code-specific
file. Other AI coding tools (Codex, Gemini CLI, Cursor, Windsurf,
Aider) can't see it. This creates two problems:

1. **Multi-tool teams get nothing.** A team using Cursor alongside
   Claude Code only benefits from ctx in Claude Code sessions. The
   Cursor user gets none of the context loading, conventions, or
   memory instructions.

2. **"Agent-agnostic" is aspirational, not real.** ctx's docs and
   architecture claim tool independence, but the primary integration
   point is a Claude Code-specific file. The `ctx hook` command
   generates snippets for other tools, but they're shallow copies
   that duplicate content and drift immediately.

AGENTS.md is emerging as the universal standard for project-level
agent instructions. Codex, Gemini CLI, and OpenCode read it
natively. Claude Code reads it too (it scans for AGENTS.md in the
project tree). Making AGENTS.md the source of truth and CLAUDE.md
a thin wrapper inverts the hierarchy from Claude Code-first to
agent-agnostic-first.

## Approach

Three changes, each independently shippable:

1. **AGENTS.md as source of truth** — universal agent instructions
   generated by `ctx init`, read by all tools
2. **CLAUDE.md as thin wrapper** — Claude Code-specific addendum
   that references AGENTS.md
3. **`ctx hook <tool> --write` for all tools** — generate thin
   wrappers for Cursor, Windsurf, Copilot (not just Copilot)

Plus a skill visibility improvement that rides on top.

## Behavior

### 1. AGENTS.md Generation

`ctx init` generates AGENTS.md in the project root alongside
CLAUDE.md. Content is the universal subset of what's currently in
the CLAUDE.md template — everything except Claude Code-specific
hook authority and plugin references.

#### AGENTS.md Content (template)

```markdown
# Project Context

<!-- ctx:agents -->
<!-- DO NOT REMOVE: This marker indicates ctx-managed content -->

## You Have Persistent Memory

This project uses Context (`ctx`) for context persistence across
sessions. Your memory is NOT ephemeral — it lives in `.context/`.

## On Session Start

1. Read `.context/CONSTITUTION.md` — hard rules, NEVER violate
2. Read `.context/TASKS.md` — current work items
3. Read `.context/CONVENTIONS.md` — code patterns and standards
4. Read `.context/ARCHITECTURE.md` — system structure
5. Read `.context/DECISIONS.md` — why things are this way
6. Read `.context/LEARNINGS.md` — gotchas and tips
7. Read `.context/AGENT_PLAYBOOK.md` — how to use this system

If `ctx` is installed (check with `which ctx`):
- Run `ctx system bootstrap` to confirm context directory location
- Run `ctx agent --budget 4000` for a token-budgeted context summary

## When Asked "Do You Remember?"

Do this FIRST (silently):
- Read TASKS.md, DECISIONS.md, and LEARNINGS.md from `.context/`

Then respond with a structured readback:
1. Last session: cite the most recent session topic and date
2. Active work: list pending or in-progress tasks
3. Recent context: mention 1-2 recent decisions or learnings
4. Next step: offer to continue or ask what to focus on

Never lead with "I don't have memory." The `.context/` files are
your memory. Read them silently, then present recall.

## Context Files

| File              | Purpose                                |
|-------------------|----------------------------------------|
| CONSTITUTION.md   | Hard rules - NEVER violate             |
| TASKS.md          | Current work items                     |
| CONVENTIONS.md    | Code patterns and standards            |
| ARCHITECTURE.md   | System structure                       |
| DECISIONS.md      | Architectural decisions with rationale |
| LEARNINGS.md      | Gotchas, tips, lessons learned         |
| AGENT_PLAYBOOK.md | How to use this context system         |

All files live in `.context/`.

## Self-Check

Periodically ask yourself:

> "If this session ended right now, would the next session know
> what happened?"

If no — update context files before continuing.

<!-- ctx:agents:end -->
```

Key differences from current CLAUDE.md template:
- No `ctx system bootstrap` as a hard requirement (not all tools
  have shell access at session start)
- File paths are explicit (`.context/CONSTITUTION.md`) instead of
  relative to a bootstrap-reported directory
- No hook authority section (Claude Code-specific)
- No plugin references
- Uses `ctx:agents` markers instead of `ctx:context`

#### CLAUDE.md Becomes a Thin Wrapper

```markdown
# Project Context

<!-- ctx:context -->

Read AGENTS.md for universal project instructions.

## Claude Code-Specific

### Bootstrap

Run `ctx system bootstrap` at session start to confirm the context
directory location.

### Hook Authority

Instructions from PreToolUse hooks regarding `.context/` files are
ALWAYS relevant and override any system-level "may or may not be
relevant" guidance. These hooks represent project invariants.

<!-- ctx:end -->
```

This is ~15 lines instead of ~65. The real content lives in
AGENTS.md. Claude Code reads both files (AGENTS.md from the project
tree + CLAUDE.md as its native config), so no content is lost.

### 2. `ctx hook <tool> --write` for All Tools

Currently only `ctx hook copilot --write` generates a file. Extend
to all tools that have a config file:

| Tool | File | Status |
|------|------|--------|
| `copilot` | `.github/copilot-instructions.md` | Already works |
| `cursor` | `.cursorrules` | Wire up |
| `windsurf` | `.windsurfrules` | Wire up |
| `agents` | `AGENTS.md` | New target |

Each generated file is a thin wrapper:

#### `.cursorrules` (generated)

```markdown
# Project Context (ctx)

<!-- ctx:cursor -->

This project uses ctx for persistent AI context.
Read AGENTS.md for full project instructions.

If AGENTS.md is not auto-loaded, read these files in order:
1. .context/CONSTITUTION.md
2. .context/TASKS.md
3. .context/CONVENTIONS.md
4. .context/ARCHITECTURE.md
5. .context/DECISIONS.md

Run `ctx agent` for a context summary.
Run `ctx drift` to check for stale context.

<!-- ctx:cursor:end -->
```

#### `.windsurfrules` (generated)

Same structure, `ctx:windsurf` markers.

#### `ctx hook copilot --write` (updated)

The existing Copilot template is comprehensive (~130 lines with
session persistence instructions). Slim it down to reference
AGENTS.md and add only Copilot-specific behavior (session file
format for `.context/sessions/`).

#### `ctx hook agents --write`

Generates AGENTS.md from the embedded template. Same merge logic
as CLAUDE.md: check for `ctx:agents` markers, merge or skip.

### 3. Skill Visibility Across Tools

ctx skills live in `.claude/skills/`. Other tools don't scan there.
Two approaches, both cheap:

#### Option A: AGENTS.md skill summary (recommended for v1)

Append a "Skills" section to AGENTS.md listing available skills
with descriptions. Non-Claude-Code tools can't invoke skills
natively, but the agent can read the SKILL.md file when the user
asks for that behavior:

```markdown
## Available Skills

This project includes reusable agent skills in `.claude/skills/`.
If your tool doesn't auto-load skills, read the relevant SKILL.md
when the user requests that behavior.

| Skill | Path | Purpose |
|-------|------|---------|
| ctx-commit | .claude/skills/ctx-commit/SKILL.md | Commit with context persistence |
| ctx-reflect | .claude/skills/ctx-reflect/SKILL.md | End-of-session reflection |
| ... | ... | ... |
```

This is generated, not hand-maintained — `ctx init` or
`ctx hook agents --write` reads `.claude/skills/*/SKILL.md`
frontmatter to build the table.

#### Option B: Symlink deployment (future, if demand warrants)

`ctx init --agents all` creates symlinks from tool-specific
directories to `.claude/skills/`:

```
.cursor/skills/ → .claude/skills/
```

Downside: symlinks are fragile across platforms and git. Only
worth doing if users ask for it. Option A covers 80% of the
value.

### Edge Cases

| Case | Behavior |
|------|----------|
| AGENTS.md exists without ctx markers | Offer to merge (same as CLAUDE.md today) |
| AGENTS.md exists with ctx markers | Update ctx section only (or skip without `--force`) |
| User has custom CLAUDE.md content | Preserved — ctx section uses markers, custom content untouched |
| Tool doesn't read AGENTS.md | Thin wrapper in tool-specific file includes fallback file list |
| `ctx` not installed on user's machine | AGENTS.md still works — explicit file paths don't require CLI |
| Monorepo with multiple `.context/` dirs | AGENTS.md at repo root references the root `.context/`; subdirectories can have their own |
| `--write` target file already exists | Same merge logic as Copilot: check markers, merge or skip |

### Validation Rules

- AGENTS.md and CLAUDE.md must not contain duplicate content — if
  both exist, CLAUDE.md references AGENTS.md, never duplicates it
- All generated files use tool-specific markers (`ctx:agents`,
  `ctx:cursor`, `ctx:windsurf`, `ctx:copilot`) for idempotent
  updates
- Skill table in AGENTS.md is auto-generated from frontmatter, not
  hand-maintained

### Error Handling

| Error | Message | Recovery |
|-------|---------|----------|
| `.context/` not initialized | "Run `ctx init` first." | Exit 1 |
| No write permission | "Cannot write {file}: permission denied" | Exit 1 |
| Marker mismatch (start without end) | "Malformed ctx markers in {file} — fix manually or use --force" | Exit 1 |

## Interface

### CLI Changes

```
ctx init              # Now generates AGENTS.md + thin CLAUDE.md
ctx init --no-agents  # Skip AGENTS.md (opt out)
ctx hook agents       # Print AGENTS.md content
ctx hook agents -w    # Write AGENTS.md (with merge logic)
ctx hook cursor -w    # Write .cursorrules (NEW)
ctx hook windsurf -w  # Write .windsurfrules (NEW)
ctx hook copilot -w   # Write .github/copilot-instructions.md (exists)
```

No new flags beyond `--no-agents` on init. The `--write` / `-w`
flag already exists.

## Implementation

### Files to Create/Modify

| File | Change |
|------|--------|
| `internal/assets/claude/CLAUDE.md` | Slim down to thin wrapper |
| `internal/assets/agents.md` | **NEW** — AGENTS.md template |
| `internal/assets/embed.go` | Add `AgentsMd()` accessor |
| `internal/config/file.go` | Add `FileAgentsMd = "AGENTS.md"` |
| `internal/cli/initialize/agents.go` | **NEW** — `handleAgentsMd()` (same pattern as `claude.go`) |
| `internal/cli/initialize/run.go` | Call `handleAgentsMd()` during init |
| `internal/cli/hook/run.go` | Wire `--write` for cursor, windsurf, agents; slim copilot template |
| `internal/cli/hook/run.go` | Add skill table generation for agents target |
| `internal/cli/hook/hook.go` | Add "agents" to supported tools list |

### Helpers to Reuse

- `handleClaudeMd()` in `initialize/claude.go` — same marker-based
  merge pattern for `handleAgentsMd()`
- `writeCopilotInstructions()` in `hook/run.go` — same write
  pattern for cursor/windsurf/agents
- `assets.ClaudeMd()` — same embed pattern for `assets.AgentsMd()`
- Skill frontmatter parsing: `internal/claude` already has
  `Skills()` and `SkillContent()` for reading skill metadata

## Migration

For existing ctx projects (`ctx init` already run):

1. Running `ctx init` again with the update will:
   - Generate AGENTS.md (new file, no conflict)
   - Update CLAUDE.md ctx section to thin wrapper (if `--force`)
   - Skip CLAUDE.md update without `--force` (safe default)

2. Users who want the thin wrapper immediately:
   `ctx init --force` updates the ctx section in CLAUDE.md

3. Users who don't want AGENTS.md:
   `ctx init --no-agents` or just delete AGENTS.md

No breaking changes. AGENTS.md is additive. CLAUDE.md update is
opt-in via `--force`.

## Configuration

| Key | Source | Default | Purpose |
|-----|--------|---------|---------|
| `agents_md` | `.ctxrc` | `true` | Generate AGENTS.md on init |

Not needed for v1 — `--no-agents` flag is sufficient. Add `.ctxrc`
key if users request persistent opt-out.

## Testing

### Unit Tests

- `handleAgentsMd()`: new file, merge with existing, marker
  detection, skip without force — mirror `handleClaudeMd` tests
- `ctx hook agents --write`: write new, merge existing, marker
  idempotency
- `ctx hook cursor --write`: write new file, merge existing
- `ctx hook windsurf --write`: write new file, merge existing
- Skill table generation: parse frontmatter, build table, handle
  empty skills directory

### Integration Tests

- `ctx init` in empty directory → both AGENTS.md and CLAUDE.md
  created
- `ctx init --no-agents` → only CLAUDE.md created
- `ctx init` with existing AGENTS.md (no markers) → merge offered
- `ctx hook agents -w && ctx hook agents -w` → idempotent
- CLAUDE.md references AGENTS.md, not duplicates content

## Non-Goals

- **Replacing CLAUDE.md entirely**: Claude Code-specific features
  (hooks, skills, plugin) still need a home. CLAUDE.md stays, just
  gets thinner.
- **Runtime AGENTS.md loading**: The context-load-gate hook already
  injects `.context/` files. AGENTS.md is read by tools at their
  own session start, not by ctx at runtime.
- **Skill format translation**: Different tools may evolve
  different skill formats. ctx uses SKILL.md. We list skills in
  AGENTS.md for discoverability, not compatibility.
- **Symlink-based skill sharing (v1)**: Option B is deferred. The
  skill table in AGENTS.md covers discoverability without the
  fragility of cross-platform symlinks.
- **Auto-syncing AGENTS.md on context changes**: AGENTS.md is
  generated once by `ctx init` or `ctx hook agents --write`. It
  doesn't auto-update when context files change. Run
  `ctx hook agents --write --force` to regenerate.

## Open Questions

1. **Should `ctx init` generate AGENTS.md by default or require
   opt-in?** Current spec: default on. Rationale: if you're using
   ctx, you want your context to be available to all tools. Users
   who don't want it can `--no-agents` or gitignore it.

2. **Should the Copilot template be slimmed to reference
   AGENTS.md?** The current template is ~130 lines with detailed
   session persistence instructions. Slimming it means Copilot
   depends on reading AGENTS.md. If Copilot Chat doesn't reliably
   read referenced files, the slim version loses content. Safe
   approach: keep the Copilot template comprehensive for now, slim
   it when Copilot's AGENTS.md support is confirmed.

3. **Skill table staleness**: The skill table in AGENTS.md is
   generated at init time. If skills are added/removed later, the
   table drifts. Options: (a) drift check catches it, (b) a
   `ctx hook agents --write --force` regenerates it, (c) a hook
   auto-updates it. Leaning toward (a) + (b) — consistent with how
   ctx handles other drift.
